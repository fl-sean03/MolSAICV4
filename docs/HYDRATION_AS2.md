# Alumina AS2 Hydration — Code-first V3 Pilot

Objective
- Reproduce the original pipeline’s final LAMMPS .data artifact for AS2 hydration using a simplified, plugin-free, code-first setup.
- Inputs vendored under [assets/AluminaSurfaces](MOLSAICV3/assets/AluminaSurfaces) for self-contained reproducibility.
- External executables invoked by thin wrappers (no registry, no YAML, no executor).

Primary references
- Original YAML (source of truth for steps/parameters): [workflows/pipeline-alumina-AS2-hydration.yaml](workflows/pipeline-alumina-AS2-hydration.yaml:1)
- V3 plan and architecture: [MOLSAICV3/docs/PLAN_V3.md](MOLSAICV3/docs/PLAN_V3.md:1)
- V3 DevDoc: [MOLSAICV3/DevDoc.md](MOLSAICV3/DevDoc.md:1)
- Rerun notes and acceptance from v1/v2: [docs/AluminaHydration_Rerun_2025-10.md](docs/AluminaHydration_Rerun_2025-10.md:1)

Executables (defaults)
- msi2namd: /home/sf2/LabWork/software/msi2namd.exe
- packmol: /home/sf2/LabWork/software/packmol-20.15.3/packmol
- msi2lmp: /home/sf2/LabWork/software/msi2lmp.exe

Vendored assets (self-contained)
- Templates
  - [MOLSAICV3/assets/AluminaSurfaces/templates/AS2.car](MOLSAICV3/assets/AluminaSurfaces/templates/AS2.car)
  - [MOLSAICV3/assets/AluminaSurfaces/templates/AS2.mdf](MOLSAICV3/assets/AluminaSurfaces/templates/AS2.mdf)
  - [MOLSAICV3/assets/AluminaSurfaces/templates/WAT.car](MOLSAICV3/assets/AluminaSurfaces/templates/WAT.car)
  - [MOLSAICV3/assets/AluminaSurfaces/templates/WAT.mdf](MOLSAICV3/assets/AluminaSurfaces/templates/WAT.mdf)
- Packmol deck
  - [MOLSAICV3/assets/AluminaSurfaces/packmol/packmol_AS2.inp](MOLSAICV3/assets/AluminaSurfaces/packmol/packmol_AS2.inp)
- Parameters
  - [MOLSAICV3/assets/AluminaSurfaces/prm_files/parameters.prm](MOLSAICV3/assets/AluminaSurfaces/prm_files/parameters.prm)
  - [MOLSAICV3/assets/AluminaSurfaces/frc_files/cvff_IFF_metal_oxides_v2.frc](MOLSAICV3/assets/AluminaSurfaces/frc_files/cvff_IFF_metal_oxides_v2.frc)

Workspace layout (planned)
- [MOLSAICV3/workspaces/alumina_AS2_hydration_v1/run.py](MOLSAICV3/workspaces/alumina_AS2_hydration_v1/run.py)
- [MOLSAICV3/workspaces/alumina_AS2_hydration_v1/config.json](MOLSAICV3/workspaces/alumina_AS2_hydration_v1/config.json)
- Outputs (generated by run.py)
  - outputs/AS2.pdb, outputs/WAT.pdb
  - outputs/hydrated_AS2.pdb
  - outputs/converted/AS2_hydrated.car
  - outputs/converted/AS2_hydrated.mdf
  - outputs/simulation/AS2_hydration.data
  - outputs/summary.json

Pipeline mapping (YAML → code-first)

1) Convert AS2 and WAT to PDB/PSF (msi2namd)
- V3 call: [msi2namd.run()](MOLSAICV3/molsaicv3/usm/external/msi2namd.py:1)
  - Inputs:
    - mdf_file: assets/AluminaSurfaces/templates/AS2.mdf (or WAT.mdf)
    - car_file: assets/AluminaSurfaces/templates/AS2.car (or WAT.car)
    - prm_file: assets/AluminaSurfaces/prm_files/parameters.prm
    - residue: AS2 or WAT (≤ 4 chars)
    - output_prefix: AS2 or WAT
    - exe_path: /home/sf2/LabWork/software/msi2namd.exe
  - Outputs:
    - AS2.pdb, AS2.psf (and similarly WAT.pdb, WAT.psf) written under outputs/
  - Notes:
    - Use absolute exe path; add exe directory to PATH in env
    - Capture stdout/stderr; fail-fast on non-zero exit

2) Assemble hydration with Packmol
- V3 call: [packmol.run()](MOLSAICV3/molsaicv3/usm/external/packmol.py:1)
  - Inputs:
    - deck_path: assets/AluminaSurfaces/packmol/packmol_AS2.inp
    - exe_path: /home/sf2/LabWork/software/packmol-20.15.3/packmol
  - Behavior:
    - Ensure deck references AS2.pdb and WAT.pdb (produced in step 1)
    - Output hydrated_AS2.pdb under outputs/
  - Notes:
    - Validate existence of referenced input PDBs before invocation
    - Capture Packmol-reported timings for summary.json

3) Convert hydrated PDB back to CAR/MDF with USM (pm2mdfcar)
- V3 call: [pm2mdfcar.build()](MOLSAICV3/molsaicv3/usm/ops/pm2mdfcar.py:1)
  - Inputs:
    - pdb_file: outputs/hydrated_AS2.pdb
    - templates_dir: assets/AluminaSurfaces/templates
    - output_prefix: outputs/converted/AS2_hydrated
    - target_c: 81.397
  - Operations:
    - Load hydrated PDB coordinates
    - Load AS2 and WAT templates (CAR+MDF) to provide topology (labels/types/bonds)
    - Compose topology for hydrated coordinates (preserve intra-species topology)
    - Set cell: a,b from AS2 template; c := 81.397; recenter and wrap if needed
    - Deterministic renumber; MDF export in normalized mode; CAR with numeric PBC
  - Outputs:
    - outputs/converted/AS2_hydrated.car
    - outputs/converted/AS2_hydrated.mdf

4) Generate LAMMPS .data via msi2lmp
- V3 call: [msi2lmp.run()](MOLSAICV3/molsaicv3/usm/external/msi2lmp.py:1)
  - Inputs:
    - base_name: outputs/converted/AS2_hydrated (base for .car/.mdf)
    - frc_file: assets/AluminaSurfaces/frc_files/cvff_IFF_metal_oxides_v2.frc
    - exe_path: /home/sf2/LabWork/software/msi2lmp.exe
    - output_prefix: outputs/simulation/AS2_hydration
    - normalize_xy: true (optional post-normalization)
    - normalize_z_to: 81.397 (optional post-normalization)
  - Behavior:
    - Run msi2lmp in directory containing base_name.{car,mdf}
    - Expect base_name.data; rename to output_prefix.data
    - If normalize flags set: adjust header and z-shift to match configured box
  - Outputs:
    - outputs/simulation/AS2_hydration.data

Config (planned) [workspaces/alumina_AS2_hydration_v1/config.json](MOLSAICV3/workspaces/alumina_AS2_hydration_v1/config.json:1)
```json
{
  "assets_root": "assets/AluminaSurfaces",
  "executables": {
    "msi2namd": "/home/sf2/LabWork/software/msi2namd.exe",
    "packmol": "/home/sf2/LabWork/software/packmol-20.15.3/packmol",
    "msi2lmp": "/home/sf2/LabWork/software/msi2lmp.exe"
  },
  "params": {
    "residue_as2": "AS2",
    "residue_wat": "WAT",
    "target_c": 81.397,
    "normalize_xy": true,
    "normalize_z_to": 81.397
  },
  "paths": {
    "templates": "assets/AluminaSurfaces/templates",
    "deck": "assets/AluminaSurfaces/packmol/packmol_AS2.inp",
    "prm": "assets/AluminaSurfaces/prm_files/parameters.prm",
    "frc": "assets/AluminaSurfaces/frc_files/cvff_IFF_metal_oxides_v2.frc"
  },
  "outputs": {
    "dir": "workspaces/alumina_AS2_hydration_v1/outputs"
  }
}
```

Run instructions (once workspace script exists)
- Single command:
  - python [workspaces/alumina_AS2_hydration_v1/run.py](MOLSAICV3/workspaces/alumina_AS2_hydration_v1/run.py:1) --config [workspaces/alumina_AS2_hydration_v1/config.json](MOLSAICV3/workspaces/alumina_AS2_hydration_v1/config.json:1)
- Artifacts written under [workspaces/alumina_AS2_hydration_v1/outputs](MOLSAICV3/workspaces/alumina_AS2_hydration_v1/outputs)

Summary manifest (outputs/summary.json)
- inputs
  - assets versions/paths: templates (AS2/WAT), deck, prm, frc
  - executables: msi2namd, packmol, msi2lmp (absolute paths)
- parameters
  - residues, target_c, normalize flags
- counts
  - waters placed (from hydrated PDB), atom totals before/after compose
- cell
  - a, b from AS2 template; c = 81.397; angles
- outputs
  - paths to hydrated pdb, car, mdf, and .data
- timings
  - per-step durations; overall duration

Acceptance criteria
- [ ] outputs/simulation/AS2_hydration.data exists after run
- [ ] outputs/converted/AS2_hydrated.{car,mdf} exist with equal atom counts and matching labels
- [ ] CAR has numeric PBC header (PBC a b c α β γ)
- [ ] Cell c equals 81.397 Å; XY equals AS2 template (normalize_xy=true)
- [ ] Summary manifest populated with inputs, parameters, counts, cell, outputs, timings
- [ ] Re-running with identical config yields identical structured values (timestamps excepted)

Troubleshooting
- msi2namd: Verify residue length (≤ 4 chars); check executable path and prm path; inspect stdout/stderr captured by [msi2namd.run()](MOLSAICV3/molsaicv3/usm/external/msi2namd.py:1)
- packmol: Ensure deck references AS2.pdb, WAT.pdb relative to run cwd; adjust paths or copy PDBs next to deck; inspect logs via [packmol.run()](MOLSAICV3/molsaicv3/usm/external/packmol.py:1)
- pm2mdfcar: If MDF parsing fails in downstream msi2lmp, ensure normalized connections emit; minimize extraneous blocks; see [pm2mdfcar.build()](MOLSAICV3/molsaicv3/usm/ops/pm2mdfcar.py:1)
- msi2lmp: If .data missing, confirm base_name.data convention; check frc filename; post-normalize header and z as configured in [msi2lmp.run()](MOLSAICV3/molsaicv3/usm/external/msi2lmp.py:1)

Mapping to original YAML (for audit)
- Step 1: namd_as2 → [msi2namd.run()](MOLSAICV3/molsaicv3/usm/external/msi2namd.py:1)
- Step 2: namd_wat → [msi2namd.run()](MOLSAICV3/molsaicv3/usm/external/msi2namd.py:1)
- Step 3: packmol_hydrate_as2 → [packmol.run()](MOLSAICV3/molsaicv3/usm/external/packmol.py:1)
- Step 4: pm2mdfcar_as2_hydrated → [pm2mdfcar.build()](MOLSAICV3/molsaicv3/usm/ops/pm2mdfcar.py:1)
- Step 5: msi2lmp_as2 → [msi2lmp.run()](MOLSAICV3/molsaicv3/usm/external/msi2lmp.py:1)

Mermaid
flowchart LR
  A[Assets AS2 WAT prm frc deck] --> B[msi2namd run]
  B --> C[PDBs AS2 WAT]
  C --> D[packmol run]
  D --> E[hydrated_AS2 pdb]
  E --> F[pm2mdfcar build]
  F --> G[AS2_hydrated car mdf]
  G --> H[msi2lmp run]
  H --> I[AS2_hydration data]

Next
- Implement wrappers in:
  - [msi2namd.run()](MOLSAICV3/molsaicv3/usm/external/msi2namd.py:1), [packmol.run()](MOLSAICV3/molsaicv3/usm/external/packmol.py:1), [msi2lmp.run()](MOLSAICV3/molsaicv3/usm/external/msi2lmp.py:1)
- Implement [pm2mdfcar.build()](MOLSAICV3/molsaicv3/usm/ops/pm2mdfcar.py:1)
- Scaffold workspace under [workspaces/alumina_AS2_hydration_v1](MOLSAICV3/workspaces/alumina_AS2_hydration_v1/run.py:1)
- Add integration test [tests/integration/test_as2_hydration.py](MOLSAICV3/tests/integration/test_as2_hydration.py:1)