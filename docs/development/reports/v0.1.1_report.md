# MolSAIC v0.1.1 Implementation Report — USM + UPM + External Wrappers + Golden Workspace (Determinism-first)

**Date:** 2025-12-16  
**Status:** Implemented + validated via unit + integration tests (workspace regression anchor added)  
**Primary spec:** [`DevGuide_v0.1.1.md`](docs/development/guides/DevGuide_v0.1.1.md:1)  
**Reference report format:** [`v0.1.0_report.md`](src/upm/docs/DevGuides/v0.1.0_report.md:1)

---

## 1. Executive Summary

MolSAIC v0.1.1 delivers a deterministic, code-first, end-to-end pipeline proving the intended architecture:

**USM (CAR+MDF) → Requirements JSON → UPM minimal `.frc` → external `msi2lmp` wrapper → deterministic run manifest**

Key outcomes per [`DevGuide_v0.1.1.md`](docs/development/guides/DevGuide_v0.1.1.md:1):

- **USM Requirements derivation** is implemented inside USM (UPM-independent) with deterministic bond/angle enumeration and stable JSON writing:  
  - [`derive_requirements_v0_1()`](src/usm/ops/requirements.py:105)  
  - [`write_requirements_json()`](src/usm/ops/requirements.py:163)
- **UPM v0.1.1 feature bump** is implemented:
  - Angles end-to-end (tables + validation + codec + resolver):  
    - [`TABLE_SCHEMAS[angles]`](src/upm/src/upm/core/tables.py:36)  
    - [`validate_angles()`](src/upm/src/upm/core/validate.py:222)  
    - [`#quadratic_angle` parse/export](src/upm/src/upm/codecs/msi_frc.py:1)  
    - [`resolve_minimal()`](src/upm/src/upm/core/resolve.py:63) now enforces required `angle_types`
  - Missing-term modes + deterministic missing report:
    - CLI semantics in [`export_frc`](src/upm/src/upm/cli/commands/export_frc.py:54)
  - Unknown/raw section policy is explicit and deterministic:
    - default omit, optional `--include-raw` (encounter order) in [`write_frc()`](src/upm/src/upm/codecs/msi_frc.py:108)
  - Standalone toy structure Requirements derivation + CLI:
    - [`requirements_from_structure_json()`](src/upm/src/upm/io/requirements.py:195)  
    - [`upm derive-req`](src/upm/src/upm/cli/commands/derive_req.py:29)
- **External wrapper contract** is hardened and test-validated:
  - Contract: [`ADAPTER_CONTRACT.md`](docs/reference/ADAPTER_CONTRACT.md:1)  
  - Envelope: [`ExternalToolResult.to_dict()`](src/external/adapter.py:83)  
  - `msi2lmp` wrapper guarantees `result.json` even when missing tool: [`msi2lmp.run()`](src/external/msi2lmp.py:112)
- **Golden workspace + integration test** are added as the determinism regression anchor:
  - Workspace runner: [`workspaces/02_usm_upm_msi2lmp_pipeline/run.py`](workspaces/02_usm_upm_msi2lmp_pipeline/run.py:1)  
  - Integration determinism test: [`test_golden_workspace_determinism`](tests/integration/test_golden_usm_upm_msi2lmp_pipeline.py:85)

---

## 2. Problem / Motivation (Why v0.1.1)

This milestone targets “deterministic pipelines from composable blocks” rather than a workflow engine. Historically, forcing functions were:

- External tools and parameter files treated as opaque → hard to validate, subset, or reproduce.
- Non-deterministic outputs (ordering, ad-hoc workdirs, implicit PATH behavior) → “works on my machine” issues.
- Unclear package boundaries (structure logic vs. parameter logic vs. orchestration logic).

v0.1.1 establishes:

- **Where** topology requirements are derived (USM)
- **Where** parameter resolution lives (UPM)
- **How** external tools are invoked and recorded (adapter envelope)
- **How** pipelines are documented and reproducibly executed (workspaces + deterministic manifest)

---

## 3. Implementation Overview (What changed)

### 3.1 USM — deterministic Requirements derivation (UPM-independent)

**Spec driver:** [`DevGuide_v0.1.1.md`](docs/development/guides/DevGuide_v0.1.1.md:76) (Scope boundaries + canonicalization rules)

**Files:**
- Requirements derivation: [`src/usm/ops/requirements.py`](src/usm/ops/requirements.py:1)
- Tests: [`src/usm/tests/test_requirements_derivation.py`](src/usm/tests/test_requirements_derivation.py:1)

**Behavior:**
- Reads `structure.atoms.atom_type` and optional `structure.bonds[a1,a2]`.
- Canonicalization rules match v0.1.1 spec:
  - bonds canonicalized so `t1 <= t2`: [`_canonicalize_bond_key()`](src/usm/ops/requirements.py:17)
  - angles canonicalized so endpoints satisfy `t1 <= t3`: [`_canonicalize_angle_key()`](src/usm/ops/requirements.py:23)
- Deterministic angle enumeration from adjacency (neighbors deduped + sorted): [`derive_requirements_v0_1()`](src/usm/ops/requirements.py:105)
- Stable JSON writer (`indent=2`, `sort_keys=True`, newline): [`write_requirements_json()`](src/usm/ops/requirements.py:163)

**Validated by:**
- Canonical expectations and ordering: [`test_derive_requirements_v0_1_linear_chain_canonical`](src/usm/tests/test_requirements_derivation.py:15)
- Determinism under bond order/reversal: [`test_derive_requirements_v0_1_deterministic_under_bond_row_order`](src/usm/tests/test_requirements_derivation.py:128)
- Graceful “no bonds” degradation: [`test_derive_requirements_v0_1_no_bonds_graceful`](src/usm/tests/test_requirements_derivation.py:194)

### 3.2 UPM — v0.1.1 feature bump (angles + raw policy + missing-term modes + toy derive-req)

**Spec driver:** UPM thrusts in [`DevGuide_v0.1.1.md`](docs/development/guides/DevGuide_v0.1.1.md:195)

#### 3.2.1 Angles table schema + deterministic normalization

**Files:**
- Schema + normalization: [`src/upm/src/upm/core/tables.py`](src/upm/src/upm/core/tables.py:1)
  - `angles` schema: [`TABLE_SCHEMAS`](src/upm/src/upm/core/tables.py:36)
  - canonicalization endpoints `t1 <= t3`: [`normalize_angles()`](src/upm/src/upm/core/tables.py:238)

**Behavior:**
- Strict required columns, no extras.
- Canonicalizes `(t1,t2,t3)` by endpoints and stable sorts by (`t1`,`t2`,`t3`,`style`).

#### 3.2.2 Angle semantic validation

**Files:**
- Validators: [`src/upm/src/upm/core/validate.py`](src/upm/src/upm/core/validate.py:1)
  - Validator: [`validate_angles()`](src/upm/src/upm/core/validate.py:222)

**Behavior:**
- Enforces canonical endpoint invariant `t1 <= t3`.
- Enforces only `style == quadratic` in v0.1.1.

#### 3.2.3 MSI `.frc` codec: `#quadratic_angle` + deterministic raw section policy

**Files:**
- Codec: [`src/upm/src/upm/codecs/msi_frc.py`](src/upm/src/upm/codecs/msi_frc.py:1)

**Behavior:**
- Supported sections in fixed export order:
  - `#atom_types`, `#quadratic_bond`, `#quadratic_angle`, `#nonbond(12-6)` (from atom types)
- Unknown/raw sections are preserved **losslessly** as an **ordered list of sections**, and export policy is explicit:
  - Default: omit raw/unknown
  - Optional: include with deterministic encounter order when `include_raw=True`: [`write_frc()`](src/upm/src/upm/codecs/msi_frc.py:108)
- Robust parsing for “asset-style” rows:
  - Atom types asset format support: [`_parse_atom_types()`](src/upm/src/upm/codecs/msi_frc.py:289)
  - Bond asset format heuristics: [`_parse_quadratic_bond()`](src/upm/src/upm/codecs/msi_frc.py:368)
  - Angle asset format support: [`_parse_quadratic_angle()`](src/upm/src/upm/codecs/msi_frc.py:454)

#### 3.2.4 Resolver: enforce `angle_types` when present; allow-missing mode

**Files:**
- Resolver: [`src/upm/src/upm/core/resolve.py`](src/upm/src/upm/core/resolve.py:1)
  - Entry point: [`resolve_minimal()`](src/upm/src/upm/core/resolve.py:63)
  - Deterministic missing lists: [`MissingTermsError`](src/upm/src/upm/core/resolve.py:19)

**Behavior:**
- Required `atom_types` always enforced.
- Required `bond_types` enforced when non-empty.
- Required `angle_types` enforced when non-empty.
- `dihedral_types` are treated as “missing” deterministically (forward-compat placeholder): [`resolve_minimal()`](src/upm/src/upm/core/resolve.py:211)
- `allow_missing=True` returns `(ResolvedFF, MissingTermsError)` instead of raising, enabling debug exports without losing missing-term info: [`resolve_minimal()`](src/upm/src/upm/core/resolve.py:63)

#### 3.2.5 CLI: `export-frc` v0.1.1 semantics + `derive-req`

**Files:**
- Export command: [`src/upm/src/upm/cli/commands/export_frc.py`](src/upm/src/upm/cli/commands/export_frc.py:1)
  - Flags: `--include-raw`, `--allow-missing`, `--force`, `--missing-report`
  - Deterministic `missing.json` schema + ordering: [`export_frc()`](src/upm/src/upm/cli/commands/export_frc.py:54)
- Derive requirements command: [`src/upm/src/upm/cli/commands/derive_req.py`](src/upm/src/upm/cli/commands/derive_req.py:1)

#### 3.2.6 Toy structure JSON → Requirements derivation (standalone UPM)

**Files:**
- Derivation implementation: [`requirements_from_structure_json()`](src/upm/src/upm/io/requirements.py:195)
- Tests: [`src/upm/tests/test_requirements_io.py`](src/upm/tests/test_requirements_io.py:1)

**Behavior:**
- Validates a toy schema:
  - `atoms: [{aid, atom_type}, ...]` required
  - `bonds: [{a1, a2}, ...]` optional
- Deterministic canonical output:
  - Unique + sorted atom types
  - Canonical undirected bond types
  - Derived angles from adjacency; endpoints canonicalized
  - Dihedrals empty in v0.1.1

**Validated by:**
- Determinism under reordered atoms/bonds: [`test_requirements_from_structure_json_deterministic_under_atom_and_bond_order`](src/upm/tests/test_requirements_io.py:112)
- Missing bonds yields empty bond/angle: [`test_requirements_from_structure_json_missing_bonds_yields_empty_bond_and_angle_lists`](src/upm/tests/test_requirements_io.py:159)
- Invalid bond indices hard-error: [`test_requirements_from_structure_json_invalid_bond_indices_hard_error`](src/upm/tests/test_requirements_io.py:176)

### 3.3 MolSAIC — golden workspace + deterministic manifest + hardened external wrapper

#### 3.3.1 Deterministic manifest utilities

**Files:**
- Stable JSON + sha256 + version capture:
  - [`write_json_stable()`](src/molsaic/manifest_utils.py:27)
  - [`sha256_file()`](src/molsaic/manifest_utils.py:12)
  - [`get_runtime_versions()`](src/molsaic/manifest_utils.py:88)
  - [`relpath_posix()`](src/molsaic/manifest_utils.py:35)

**Key constraint enforced:**
- Workspace manifests must not include absolute paths/timestamps (determinism): implemented explicitly in the golden workspace runner’s manifest logic: [`run_manifest.json builder`](workspaces/02_usm_upm_msi2lmp_pipeline/run.py:239)

#### 3.3.2 External wrapper envelope contract + `msi2lmp` hardening

**Files:**
- Contract: [`docs/reference/ADAPTER_CONTRACT.md`](docs/reference/ADAPTER_CONTRACT.md:1)
- Envelope + helpers:
  - [`ExternalToolResult`](src/external/adapter.py:51)
  - [`get_tool_version()`](src/external/adapter.py:125)
  - Missing tool semantics referenced in contract: [`Deterministic result persistence`](docs/reference/ADAPTER_CONTRACT.md:37)
- Wrapper:
  - [`msi2lmp.run()`](src/external/msi2lmp.py:112)

**Behavior:**
- Deterministic workdir selection; captures stdout/stderr to files; computes output hashes.
- Always writes `result.json` for debugging and manifests, including the missing-tool case:
  - missing tool returns `status="missing_tool"` and still writes stdout/stderr/result.json: [`missing tool behavior`](src/external/msi2lmp.py:168)

**Validated by:**
- Wrapper schema and normalization test: [`test_msi2lmp_wrapper_schema_and_normalization`](tests/unit/test_wrappers_schema.py:82)
- Missing tool writes result.json: [`test_msi2lmp_missing_tool_writes_result_json`](tests/unit/test_wrappers_schema.py:170)

#### 3.3.3 Golden workspace (integration anchor)

**Files:**
- Runner: [`workspaces/02_usm_upm_msi2lmp_pipeline/run.py`](workspaces/02_usm_upm_msi2lmp_pipeline/run.py:1)
- Config: [`workspaces/02_usm_upm_msi2lmp_pipeline/config.json`](workspaces/02_usm_upm_msi2lmp_pipeline/config.json:1)
- Integration test: [`tests/integration/test_golden_usm_upm_msi2lmp_pipeline.py`](tests/integration/test_golden_usm_upm_msi2lmp_pipeline.py:1)

**Workspace behavior highlights:**
- Stages all inputs under `outputs/inputs/` to ensure manifests only contain relpaths: [`staging logic`](workspaces/02_usm_upm_msi2lmp_pipeline/run.py:123)
- Derives Requirements from MDF-loaded topology: [`write_requirements_json call`](workspaces/02_usm_upm_msi2lmp_pipeline/run.py:147)
- Imports `.frc` into an output-local package cache and resolves minimal `.frc` deterministically: [`UPM resolve + export`](workspaces/02_usm_upm_msi2lmp_pipeline/run.py:152)
- Always invokes wrapper, but CI-safe behavior is achieved by pointing to a missing executable (wrapper returns `missing_tool`): enforced in integration test: [`forced missing exe`](tests/integration/test_golden_usm_upm_msi2lmp_pipeline.py:42)
- `run_manifest.json` is stable across runs:
  - schema tag: `molsaic.run_manifest.v0.1.1`: [`manifest schema`](workspaces/02_usm_upm_msi2lmp_pipeline/run.py:259)
  - determinism enforced by strict byte equality across two runs in the integration test: [`byte equality assertions`](tests/integration/test_golden_usm_upm_msi2lmp_pipeline.py:99)

---

## 4. Validation & Test Results

### 4.1 v0.1.1 regression anchor (MolSAIC integration test)

- Workspace determinism + missing-tool semantics:
  - [`test_golden_workspace_determinism`](tests/integration/test_golden_usm_upm_msi2lmp_pipeline.py:85)

Validates:
- `requirements.json` deterministic bytes
- `ff_minimal.frc` deterministic bytes
- `run_manifest.json` deterministic bytes and parsed dict equality
- external wrapper status is `missing_tool` and `result.json` exists

### 4.2 External wrapper schema validation

- Wrapper schema, outputs, hashing, and normalization:
  - [`test_msi2lmp_wrapper_schema_and_normalization`](tests/unit/test_wrappers_schema.py:82)
  - [`test_msi2lmp_missing_tool_writes_result_json`](tests/unit/test_wrappers_schema.py:170)

### 4.3 USM requirements derivation tests

- Canonicalization + determinism + error handling:
  - [`src/usm/tests/test_requirements_derivation.py`](src/usm/tests/test_requirements_derivation.py:1)

### 4.4 UPM requirements I/O + toy derive-req tests

- Canonicalization + determinism + error handling:
  - [`src/upm/tests/test_requirements_io.py`](src/upm/tests/test_requirements_io.py:1)

---

## 5. Deliverables (What to run / where to look)

### 5.1 Run the golden workspace

- Workspace entry point: [`workspaces/02_usm_upm_msi2lmp_pipeline/run.py`](workspaces/02_usm_upm_msi2lmp_pipeline/run.py:1)
- Default config: [`workspaces/02_usm_upm_msi2lmp_pipeline/config.json`](workspaces/02_usm_upm_msi2lmp_pipeline/config.json:1)

Outputs (under `outputs_dir`):
- `requirements.json`
- `ff_minimal.frc`
- `msi2lmp_run/result.json` + stdout/stderr captures
- `run_manifest.json` (stable, relpaths only)

### 5.2 Use the UPM CLI for toy structure derivation

- Command implementation: [`upm derive-req`](src/upm/src/upm/cli/commands/derive_req.py:29)
- Derivation logic: [`requirements_from_structure_json()`](src/upm/src/upm/io/requirements.py:195)

### 5.3 Adapter contract reference

- Contract: [`ADAPTER_CONTRACT.md`](docs/reference/ADAPTER_CONTRACT.md:1)

---

## 6. Insights Gained (Architecture + determinism)

1) **Separation of concerns is the key enabler for refactoring**
- Requirements derivation belongs in USM because it is topology-derived and UPM-independent: [`Scope boundaries`](docs/development/guides/DevGuide_v0.1.1.md:74)
- UPM owns parameter semantics and resolver behavior; MolSAIC orchestrates the pipeline.

2) **Determinism requires explicit policies, not “best effort”**
- Stable ordering of derived topology and stable serialization are implemented in both USM and UPM:
  - USM: adjacency enumeration + stable JSON: [`derive_requirements_v0_1()`](src/usm/ops/requirements.py:105)
  - UPM: stable table normalization + strict validation: [`normalize_angles()`](src/upm/src/upm/core/tables.py:238), [`validate_angles()`](src/upm/src/upm/core/validate.py:222)
- Workspace manifests avoid timestamps/abs paths by construction: [`run_manifest builder`](workspaces/02_usm_upm_msi2lmp_pipeline/run.py:239)

3) **“Missing tool” semantics are essential for CI and reproducibility**
- External wrappers must not prevent deterministic pipeline validation when the executable is absent:
  - wrapper returns `status="missing_tool"` and writes `result.json`: [`missing tool behavior`](src/external/msi2lmp.py:168)
  - integration test forces missing tool and still asserts deterministic artifacts: [`forced missing exe`](tests/integration/test_golden_usm_upm_msi2lmp_pipeline.py:42)

4) **Raw/unknown preservation needs an explicit export policy**
- v0.1.1 resolves ambiguity: preserve raw sections on import, but omit by default on export; include only when requested:
  - [`write_frc()`](src/upm/src/upm/codecs/msi_frc.py:108)

---

## 7. Known Issues / Warnings Observed

1) **Pytest warning (non-fatal)**
- A `pytest-asyncio` deprecation warning can appear in some environments. It does not affect correctness of v0.1.1 outputs, but may be worth silencing/configuring in CI.

2) **Version labeling nuance**
- “v0.1.1” is used as an integration milestone + schema label (example: `molsaic.run_manifest.v0.1.1` in [`run_manifest`](workspaces/02_usm_upm_msi2lmp_pipeline/run.py:259)). This is intentionally independent of any pip package versioning decisions.

---

## 8. What’s Incomplete vs. Deferred (Per v0.1.1 scope)

Per [`DevGuide_v0.1.1.md`](docs/development/guides/DevGuide_v0.1.1.md:492), the following are intentionally deferred:

- v0.2: dihedrals + torsions end-to-end (dihedral requirements are carried and treated as missing deterministically in the resolver):
  - [`dihedral forward-compat handling`](src/upm/src/upm/core/resolve.py:211)

---

## 9. Conclusion

v0.1.1 is implemented according to the integrated DevGuide and provides a concrete, deterministic “golden pipeline” that can be used as the regression anchor for upcoming refactors and extensions:

- deterministic Requirements derivation in USM
- deterministic parameter selection + export in UPM (including angles and explicit raw handling)
- deterministic external wrapper envelopes with CI-safe missing-tool semantics
- deterministic workspace outputs and manifest with a dedicated integration test

Primary spec reference: [`DevGuide_v0.1.1.md`](docs/development/guides/DevGuide_v0.1.1.md:1)