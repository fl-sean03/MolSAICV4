# MolSAIC v0.1.2 Implementation Report — TermSet + ParameterSet bridge + nonbond-only `.frc` builder (Determinism-first)

**Date:** 2025-12-18  
**Status:** Implemented + validated via unit + integration tests  
**Primary spec:** [`DevGuide_v0.1.2.md`](docs/development/guides/DevGuide_v0.1.2.md:1)  
**Reference report format:** [`v0.1.1_report.md`](docs/development/reports/v0.1.1_report.md:1)

---

## 1. Executive Summary

MolSAIC v0.1.2 adds a deterministic, coordinate-free bridge from USM structures to UPM parameter export using two explicit artifacts:

- **TermSet** (`molsaic.termset.v0.1.2`): a typed inventory of possible interaction keys derived from structure topology (no numeric parameters)
- **ParameterSet** (`upm.parameterset.v0.1.2`): per-atom-type numeric assignments (mass + LJ sigma/epsilon; no charges)

From these artifacts, v0.1.2 implements a **from-scratch nonbond-only MSI `.frc` builder** that emits a minimal `.frc` containing:

- `#atom_types`
- `#nonbond(12-6)` with **required directives** `@type A-B` and `@combination geometric`

The milestone is validated primarily by **byte-for-byte determinism** (unit tests + an integration test that runs workspace 03 twice and asserts strict byte equality).

---

## 2. What changed (high level)

### 2.1 USM — deterministic TermSet + ParameterSet derivation

**Files:**

- TermSet derivation + stable JSON writer: [`src/usm/ops/termset.py`](src/usm/ops/termset.py:1)
- ParameterSet derivation + stable JSON writer: [`src/usm/ops/parameterset.py`](src/usm/ops/parameterset.py:1)
- Tests:
  - [`src/usm/tests/test_termset_derivation.py`](src/usm/tests/test_termset_derivation.py:1)
  - [`src/usm/tests/test_parameterset_derivation.py`](src/usm/tests/test_parameterset_derivation.py:1)

**Behavior highlights:**

- TermSet canonicalizes and sorts term keys deterministically (bonds/angles/dihedrals/impropers) per spec rules.
- ParameterSet groups atoms by `atom_type` and enforces per-type consistency for required numeric columns.
- JSON writers enforce stable serialization (`indent=2`, `sort_keys=True`, newline).

### 2.2 UPM — v0.1.2 TermSet/ParameterSet I/O + from-scratch `.frc` builder

**Files:**

- TermSet validation-only reader: [`read_termset_json()`](src/upm/src/upm/io/termset.py:115)
- ParameterSet validation-only reader: [`read_parameterset_json()`](src/upm/src/upm/io/parameterset.py:68)
- From-scratch builder: [`build_frc_nonbond_only()`](src/upm/src/upm/build/frc_from_scratch.py:50)
- CLI command: [`upm build-frc`](src/upm/src/upm/cli/commands/build_frc.py:1)
- Tests:
  - [`src/upm/tests/test_termset_parameterset_io_v0_1_2.py`](src/upm/tests/test_termset_parameterset_io_v0_1_2.py:1)
  - [`src/upm/tests/test_build_frc_from_scratch_nonbond_only.py`](src/upm/tests/test_build_frc_from_scratch_nonbond_only.py:1)

**Key constraint (codec):** UPM enforces that `#nonbond(12-6)` includes `@type A-B` and `@combination geometric` (parser hard-requirement): [`_parse_nonbond_12_6()`](src/upm/src/upm/codecs/msi_frc.py:530).

**Determinism strategy:** the builder constructs a canonical `atom_types` table (with `lj_a/lj_b` derived from sigma/epsilon) and reuses the MSI codec writer for stable float formatting and deterministic section emission: [`write_frc()`](src/upm/src/upm/codecs/msi_frc.py:108).

### 2.3 MolSAIC — Workspace 03 (integration anchor)

**Files:**

- Workspace runner: [`workspaces/03_termset_parameterset_to_frc_nonbond_only/run.py`](workspaces/03_termset_parameterset_to_frc_nonbond_only/run.py:1)
- Workspace config: [`workspaces/03_termset_parameterset_to_frc_nonbond_only/config.json`](workspaces/03_termset_parameterset_to_frc_nonbond_only/config.json)
- Workspace README: [`workspaces/03_termset_parameterset_to_frc_nonbond_only/README.md`](workspaces/03_termset_parameterset_to_frc_nonbond_only/README.md)
- Integration determinism test: [`tests/integration/test_workspace_03_termset_parameterset_determinism.py`](tests/integration/test_workspace_03_termset_parameterset_determinism.py:1)

Workspace 03 is intentionally **self-contained** (no external inputs) and generates:

- `outputs/termset.json`
- `outputs/parameterset.json`
- `outputs/ff_nonbond_only.frc`
- `outputs/run_manifest.json` (relpaths + sha256, no timestamps)

---

## 3. How to run workspace 03 (from repo root)

This command is intended to work without editable installs:

```bash
python workspaces/03_termset_parameterset_to_frc_nonbond_only/run.py \
  --config workspaces/03_termset_parameterset_to_frc_nonbond_only/config.json
```

Outputs are written under:

- `workspaces/03_termset_parameterset_to_frc_nonbond_only/outputs/`

---

## 4. How determinism is tested

v0.1.2 determinism is asserted at two levels:

1) **Unit-level byte stability**

- TermSet JSON bytes stable under bond/atom reordering: [`test_derive_termset_v0_1_2_deterministic_under_bond_row_order()`](src/usm/tests/test_termset_derivation.py:15)
- ParameterSet stable under atom row reordering: [`test_derive_parameterset_v0_1_2_success_deterministic_under_atom_row_order()`](src/usm/tests/test_parameterset_derivation.py:72)
- `.frc` builder byte determinism: [`test_build_frc_nonbond_only_is_byte_deterministic()`](src/upm/tests/test_build_frc_from_scratch_nonbond_only.py:41)

2) **Integration-level determinism (workspace regression anchor)**

- Runs workspace 03 twice into separate temp dirs and asserts strict byte equality for:
  - `termset.json`, `parameterset.json`, `ff_nonbond_only.frc`, `run_manifest.json`
- Test: [`test_workspace_03_determinism()`](tests/integration/test_workspace_03_termset_parameterset_determinism.py:85)

---

## 5. Validation & repo-level verification

### 5.1 Full monorepo test suite

Run:

```bash
pytest -q
```

Expected: all tests pass. (A `pytest-asyncio` deprecation warning may appear depending on environment; it is non-fatal.)

### 5.2 Workspace 03 smoke run

Run the workspace from repo root (see section 3) and confirm expected outputs exist and are non-empty.

---

## 6. Known issues / warnings

1) **Pytest warning (non-fatal)**

In some environments, `pytest-asyncio` emits a deprecation warning about the default loop scope. This does not affect correctness or determinism, but may be worth configuring explicitly in CI.

2) **Nonbond-only scope is intentionally narrow (v0.1.2)**

v0.1.2 intentionally does **not** emit bonded coefficients (bonds/angles/dihedrals/impropers). TermSet includes these inventories for forward compatibility, but the `.frc` builder consumes only `atom_types`.

---

## 7. Conclusion

v0.1.2 is implemented according to the integrated DevGuide and adds a deterministic, portable bridge from USM topology/assignments to UPM nonbond-only `.frc` export:

- deterministic TermSet/ParameterSet artifacts
- deterministic nonbond-only `.frc` builder satisfying UPM codec constraints
- a self-contained workspace 03 used as an integration determinism regression anchor

