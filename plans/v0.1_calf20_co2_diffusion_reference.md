# v0.1 Reference System: CALF-20 + COâ‚‚ Diffusion Pipeline

**Status:** Draft / Implementation Plan  
**Target:** First end-to-end demo of MS â†’ supercell â†’ guest packing â†’ msi2lmp â†’ LAMMPS data  
**Workspace:** `workspaces/NIST/nist_calf20_3x3x3_co2_v1`

---

## 1. Objective

Build a single v0.1 reference system that proves the complete pipeline works:
- CIF import â†’ P1 expansion â†’ 3Ã—3Ã—3 supercell â†’ programmatic COâ‚‚ placement â†’ msi2lmp â†’ LAMMPS .data

This validates the core workflow before adding complexity like Nâ‚‚, Hâ‚‚O, or loading sweeps.

---

## 2. Technical Specifications

### 2.1 Material: CALF-20 MOF

| Property | Value | Source |
|----------|-------|--------|
| CIF Source | CCDC 2084733 | `assets/NIST/2084733.cif` |
| Solvent | Ethanol - MUST BE REMOVED | Framework-only run |
| Framework | Rigid in MD v0.1 | De-risks bonded params |
| Space Group | P 21/c (monoclinic) | CIF `_space_group_name_H-M_alt` |

### 2.2 Unit Cell Parameters

From CIF:
- **a** = 8.9138 Ã…
- **b** = 9.6935 Ã…  
- **c** = 9.4836 Ã…
- **Î±** = 90Â°
- **Î²** = 115.895Â°
- **Î³** = 90Â°

### 2.3 3Ã—3Ã—3 Supercell Dimensions

| Dimension | Unit Cell | Supercell (Ã—3) |
|-----------|-----------|----------------|
| a | 8.9138 Ã… | **26.74 Ã…** |
| b | 9.6935 Ã… | **29.08 Ã…** |
| c | 9.4836 Ã… | **28.45 Ã…** |
| Î± | 90Â° | 90Â° |
| Î² | 115.895Â° | 115.895Â° |
| Î³ | 90Â° | 90Â° |

### 2.4 Guest Molecules: COâ‚‚

| Property | Value | Rationale |
|----------|-------|-----------|
| Count | 27 total | 1 COâ‚‚ per unit cell in 3Ã—3Ã—3 |
| Loading | Dilute | Avoids overlap/energy blowups |
| Model | Linear, rigid | `cdc`-`cdo`-`cdc` from cvff_iff_ILs.frc |

COâ‚‚ atom types from `cvff_iff_ILs.frc`:
- `cdc`: Carbon in COâ‚‚ (mass 12.011, charge +1.0)
- `cdo`: Oxygen in COâ‚‚ (mass 15.999, charge -0.5)

### 2.5 Output Artifacts

1. **Framework-only baseline (debug):**
   - `calf20_3x3x3_framework.data`

2. **Framework + COâ‚‚ (v0.1 target):**
   - `calf20_3x3x3_co2_27.data`

---

## 3. Architecture Overview

```mermaid
flowchart TD
    subgraph Inputs
        CIF[2084733.cif]
        BUNDLE[Reference Bundle\nwith LJ/mass params]
        CO2CAR[CO2.car/mdf\ntemplate molecule]
        CO2FRC[cvff_iff_ILs.frc\nCO2 parameters]
    end

    subgraph USM Pipeline
        LOAD[load_cif\nsymmetry expand]
        PARAM[Apply parameterset\nLJ Ïƒ/Îµ, mass]
        BONDS[perceive_periodic_bonds]
        REP[replicate_supercell\n3Ã—3Ã—3]
        VALID[validate_supercell]
    end

    subgraph CO2 Placement
        GRID[Compute placement grid\n3Ã—3Ã—3 = 27 positions]
        PLACE[Generate 27 CO2 molecules\nat pore centers]
        MERGE[merge_structures\nMOF + CO2]
    end

    subgraph UPM Pipeline
        TERM[derive_termset_v0_1_2]
        PS[export_parameterset]
        FRC[FRCBuilder + ChainedSource\nExistingFRCSource + ParameterSetSource + PlaceholderSource]
    end

    subgraph MSI2LMP
        CAR[save_car/save_mdf\nCombined structure]
        MSI[msi2lmp.run\n-class I -frc ...]
        DATA[.data file output]
    end

    CIF --> LOAD
    BUNDLE --> PARAM
    LOAD --> PARAM --> BONDS --> REP --> VALID

    CO2CAR --> PLACE
    VALID --> GRID --> PLACE --> MERGE
    
    MERGE --> TERM --> PS --> FRC
    CO2FRC --> FRC
    
    FRC --> CAR --> MSI --> DATA
```

---

## 4. Implementation Steps

### Step 1: CIF Import and 3Ã—3Ã—3 Supercell Generation

**File:** `run.py` (main workspace runner)

**Operations:**
1. Load CIF with symmetry expansion: `load_cif(cif_path, expand_symmetry=True)`
2. Remove solvent atoms (O1S, C1S, C2S)
3. Apply MOF parameterset from reference bundle (LJ Ïƒ/Îµ, mass, charges)
4. Perceive periodic bonds: `perceive_periodic_bonds(usm)`
5. Replicate to 3Ã—3Ã—3: `replicate_supercell(usm, na=3, nb=3, nc=3)`
6. Validate topology: `validate_supercell(usm_super)`

**Reuse From:**
- [`nist_calf20_2x2x2_supercell/run.py`](workspaces/NIST/nist_calf20_2x2x2_supercell/run.py) - supercell workflow
- [`nist_calf20_cif_import_v1/run.py`](workspaces/NIST/nist_calf20_cif_import_v1/run.py) - solvent removal

### Step 2: Programmatic COâ‚‚ Placement

**File:** `co2_placer.py` (helper module)

**Algorithm:**
1. Load CO2 template molecule from `assets/NIST/CO2_construct/CO2.car` and `CO2.mdf`
2. Compute 27 placement positions using fractional coordinate grid:
   - For each (i, j, k) in range(3) Ã— range(3) Ã— range(3):
   - Fractional center = ((i + 0.5)/3, (j + 0.5)/3, (k + 0.5)/3)
3. Convert fractional to Cartesian using supercell lattice matrix
4. Translate CO2 template to each position
5. Assign unique molecule IDs (1-27)
6. Return combined USM with all 27 CO2 molecules

**CO2 Template Structure:**
```
C1 (cdc): [0, 0, 0] relative
O1 (cdo): [-1.162, 0, 0] relative  
O2 (cdo): [+1.162, 0, 0] relative
```

Bond length C=O from FRC: 1.162 Ã…

### Step 3: MOF + COâ‚‚ Merging

**Operations:**
1. Use `merge_structures([mof_super, co2_all], cell_policy="first")`
2. Keep MOF cell parameters (supercell box)
3. Ensure unique atom names across MOF and CO2

### Step 4: Combined Termset and Parameterset Derivation

**Operations:**
1. `derive_termset_v0_1_2(combined_usm)`
   - Atom types: MOF types + cdc, cdo
   - Bond types: MOF bonds + cdc-cdo
   - Angle types: MOF angles + cdo-cdc-cdo
2. `export_parameterset_json(combined_usm, ps_path)`

### Step 5: Unified FRC Generation

**Use ChainedSource pattern from `calf20_co2_combined_v1`:**

```python
source = ChainedSource([
    ExistingFRCSource(co2_frc_path, termset),  # Real CO2 params
    ParameterSetSource(mof_parameterset),       # MOF nonbond LJ
    PlaceholderSource(element_map),             # Fallback bonded
])
builder = FRCBuilder(termset, source, FRCBuilderConfig(strict=False))
builder.write(frc_path)
```

### Step 6: Framework-Only LAMMPS Data (Baseline)

**Operations:**
1. Use MOF supercell only (no CO2)
2. Generate framework-only termset/parameterset
3. Build FRC for framework
4. Run `msi2lmp.run()` â†’ `calf20_3x3x3_framework.data`

### Step 7: MOF+COâ‚‚ LAMMPS Data (v0.1 Target)

**Operations:**
1. Use merged MOF+CO2 structure
2. Generate combined FRC
3. Run `msi2lmp.run()` â†’ `calf20_3x3x3_co2_27.data`

### Step 8: Validation and Summary

**Validation Checks:**
1. Atom count sanity: supercell_atoms = unit_cell_atoms Ã— 27
2. CO2 count: 27 molecules Ã— 3 atoms = 81 CO2 atoms
3. Bond length statistics (MIC-aware)
4. Framework connectivity (1 connected component)
5. LAMMPS data file non-empty

**Summary Report:** `outputs/summary.json`

---

## 5. File Structure

```
workspaces/NIST/nist_calf20_3x3x3_co2_v1/
â”œâ”€â”€ config.json                    # Workspace configuration
â”œâ”€â”€ run.py                         # Main runner script
â”œâ”€â”€ co2_placer.py                  # CO2 placement helper
â”œâ”€â”€ validate_run.py                # Validation logic
â”œâ”€â”€ inputs/                        # (empty - all inputs from assets)
â””â”€â”€ outputs/                       # Generated at runtime
    â”œâ”€â”€ inputs/                    # Staged inputs
    â”œâ”€â”€ frc_files/
    â”‚   â”œâ”€â”€ ff_framework.frc       # Framework-only FRC
    â”‚   â””â”€â”€ ff_combined.frc        # MOF+CO2 FRC
    â”œâ”€â”€ msi2lmp_run/
    â”‚   â”œâ”€â”€ calf20_3x3x3_framework.car
    â”‚   â”œâ”€â”€ calf20_3x3x3_framework.mdf
    â”‚   â”œâ”€â”€ calf20_3x3x3_framework.data
    â”‚   â”œâ”€â”€ calf20_3x3x3_co2_27.car
    â”‚   â”œâ”€â”€ calf20_3x3x3_co2_27.mdf
    â”‚   â””â”€â”€ calf20_3x3x3_co2_27.data
    â”œâ”€â”€ termset.json
    â”œâ”€â”€ parameterset.json
    â”œâ”€â”€ topology_validation_report.json
    â””â”€â”€ summary.json
```

---

## 6. Configuration Schema

```json
{
  "outputs_dir": "./outputs",
  "inputs": {
    "cif": "assets/NIST/2084733.cif",
    "bundle_dir": "workspaces/NIST/nist_calf20_cif_import_v1/outputs/bundle",
    "co2_car": "assets/NIST/CO2_construct/CO2.car",
    "co2_mdf": "assets/NIST/CO2_construct/CO2.mdf",
    "co2_frc": "assets/NIST/CO2_construct/cvff_iff_ILs.frc"
  },
  "executables": {
    "msi2lmp": "/home/sf2/LabWork/software/msi2lmp.exe"
  },
  "params": {
    "supercell_dims": [3, 3, 3],
    "co2_count": 27,
    "timeout_s": 600,
    "solvent_names": ["O1S", "C1S", "C2S"]
  }
}
```

---

## 7. Dependencies on Existing Code

| Component | Module | Status |
|-----------|--------|--------|
| CIF import with symmetry | `usm.io.cif.load_cif()` | âœ… Exists |
| Periodic bond perception | `usm.ops.topology.perceive_periodic_bonds()` | âœ… Exists |
| Supercell replication | `usm.ops.replicate.replicate_supercell()` | âœ… Exists |
| Structure merging | `usm.ops.merge.merge_structures()` | âœ… Exists |
| Termset derivation | `usm.ops.termset.derive_termset_v0_1_2()` | âœ… Exists |
| FRC building | `upm.build.FRCBuilder` | âœ… Exists |
| ChainedSource | `upm.build.parameter_sources.ChainedSource` | âœ… Exists |
| ExistingFRCSource | `upm.build.parameter_sources.ExistingFRCSource` | âœ… Exists |
| msi2lmp wrapper | `external.msi2lmp.run()` | âœ… Exists |
| Bundle I/O | `usm.bundle.io.load_bundle()` | âœ… Exists |
| CO2 placer | **NEW** | ğŸ†• To implement |

---

## 8. What is NOT in v0.1 Scope

| Feature | Status | Notes |
|---------|--------|-------|
| Nâ‚‚ guest | âŒ v0.2+ | Mixed-gas selectivity later |
| Hâ‚‚O guest | âŒ v0.2+ | Humidity confound + water model |
| Loading sweep | âŒ v0.2+ | 27 â†’ 54 â†’ 81 COâ‚‚ after v0.1 |
| Flexible framework | âŒ v0.2+ | Rigid for v0.1 |
| LAMMPS simulation | âŒ Separate | Only structure building here |
| MSD/D analysis | âŒ Separate | Downstream from .data |

---

## 9. Success Criteria

1. **`calf20_3x3x3_framework.data`** exists and is non-empty
2. **`calf20_3x3x3_co2_27.data`** exists and is non-empty
3. Framework has 1 connected component
4. CO2 placement verified: 27 molecules, 81 atoms
5. Total atoms = framework_atoms + 81
6. No msi2lmp errors (or only warnings with `-ignore`)
7. Deterministic: re-runs produce identical outputs

---

## 10. Implementation Subtasks for Orchestrator

The following subtasks should be executed in sequence:

1. **Subtask 1:** Create workspace directory and config.json
2. **Subtask 2:** Implement co2_placer.py helper module
3. **Subtask 3:** Implement main run.py with framework-only path
4. **Subtask 4:** Extend run.py with CO2 placement and merging
5. **Subtask 5:** Implement validate_run.py
6. **Subtask 6:** End-to-end test execution
7. **Subtask 7:** Documentation and cleanup
